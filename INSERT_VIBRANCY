-- PARAMETRO DE PER√çODO MENSUAL
DECLARE FILTRO_PERIODO DATE DEFAULT /*'YYYY-MM-01'*/ <FILTRO_PERIODO>
;

-- BORRO REGISTROS PARA EVITAR DUPLICIDAD AL INSERTAR MISMO PERIODO VARIAS VECES
DELETE `meli-bi-data.SBOX_MKTVIS.DASH_MOTORS_VIBRANCY`
WHERE YEAR_MONTH = FILTRO_PERIODO
;


INSERT INTO `meli-bi-data.SBOX_MKTVIS.DASH_MOTORS_VIBRANCY`

SELECT 
  COALESCE(A.YEAR_MONTH,B.YEAR_MONTH) AS YEAR_MONTH
, COALESCE(A.SITE_ID,B.SITE_ID) AS SITE_ID
, COALESCE(A.USER_TYPE,B.USER_TYPE) AS USER_TYPE
, COALESCE(A.CUSTOMER_SELLER_ID,B.CUSTOMER_SELLER_ID) AS CUSTOMER_SELLER_ID
, COALESCE(A.CUSTOMER_SELLER_NAME,B.CUSTOMER_SELLER_NAME) AS CUSTOMER_SELLER_NAME
, COALESCE(A.ITEM_ID,B.ITEM_ID) AS ITEM_ID
, COALESCE(A.ITEM_TITLE_NAME,B.ITEM_TITLE_NAME) AS ITEM_TITLE_NAME
, COALESCE(A.TIER,B.TIER) AS TIER
, COALESCE(A.ITEM_STATE,B.ITEM_STATE) AS ITEM_STATE
, COALESCE(A.ITEM_CITY,B.ITEM_CITY) AS ITEM_CITY
, COALESCE(A.ITEM_STREET,B.ITEM_STREET) AS ITEM_STREET
, COALESCE(A.ITEM_NEIGHBORHOOD,B.ITEM_NEIGHBORHOOD) AS ITEM_NEIGHBORHOOD
, COALESCE(A.ITEM_LATITUD,B.ITEM_LATITUD) AS ITEM_LATITUD
, COALESCE(A.ITEM_LONGITUD,B.ITEM_LONGITUD) AS ITEM_LONGITUD
, COALESCE(A.CATEGORY_NAME_L1,B.CATEGORY_NAME_L1) AS CATEGORY_NAME_L1
, COALESCE(A.CATEGORY_NAME_L2,B.CATEGORY_NAME_L2) AS CATEGORY_NAME_L2
, COALESCE(A.CATEGORY_NAME_L3,B.CATEGORY_NAME_L3) AS CATEGORY_NAME_L3
, COALESCE(A.COMBO,B.COMBO) AS COMBO
, COALESCE(A.ITEM_PARENT_ID,B.ITEM_PARENT_ID) AS ITEM_PARENT_ID
, COALESCE(A.ITEM_DOMAIN,B.ITEM_DOMAIN) AS ITEM_DOMAIN
, COALESCE(A.ITEM_LISTING_TYPE,B.ITEM_LISTING_TYPE) AS ITEM_LISTING_TYPE
, COALESCE(A.ITEM_CONDITION,B.ITEM_CONDITION) AS ITEM_CONDITION
, COALESCE(A.KILOMETERS,B.KILOMETERS) AS KILOMETERS
, COALESCE(A.VEHICLE_YEAR,B.VEHICLE_YEAR) AS VEHICLE_YEAR
, COALESCE(A.BRAND,B.BRAND) AS BRAND
, COALESCE(A.MODEL,B.MODEL) AS MODEL
, COALESCE(A.VEHICLE_BODY_TYPE,B.VEHICLE_BODY_TYPE) AS VEHICLE_BODY_TYPE
, COALESCE(A.SHOR_VERSION,B.SHOR_VERSION) AS SHORT_VERSION
, COALESCE(A.VERSION,B.VERSION) AS VERSION
, COALESCE(A.TRANSMISSION,B.TRANSMISSION) AS TRANSMISSION
, COALESCE(A.ENGINE,B.ENGINE) AS ENGINE
, COALESCE(A.FUEL_TYPE,B.FUEL_TYPE) AS FUEL_TYPE
, COALESCE(A.DOORS,B.DOORS) AS DOORS
, COALESCE(A.COLOR,B.COLOR) AS COLOR
, COALESCE(A.STEERING,B.STEERING) AS STEERING
, COALESCE(A.LICENSE_PLATE,B.LICENSE_PLATE) AS LICENSE_PLATE
, COALESCE(A.TRACTION_CONTROL,B.TRACTION_CONTROL) AS TRACTION_CONTROL
, COALESCE(A.MOTO_TYPE,B.MOTO_TYPE) AS MOTO_TYPE
, COALESCE(A.ENGINE_DISPLACEMENT,B.ENGINE_DISPLACEMENT) AS ENGINE_DISPLACEMENT
, COALESCE(A.HAS_VIDEO,B.HAS_VIDEO) AS HAS_VIDEO
, COALESCE(A.IS_SINGLE_OWNER,B.IS_SINGLE_OWNER) AS IS_SINGLE_OWNER
, COALESCE(A.IS_FINANCEABLE,B.IS_FINANCEABLE) AS IS_FINANCEABLE
, COALESCE(A.HAS_STABILITY_CONTROL,B.HAS_STABILITY_CONTROL) AS HAS_STABILITY_CONTROL
, COALESCE(A.HAS_ABS_BRAKES,B.HAS_ABS_BRAKES) AS HAS_ABS_BRAKES
, COALESCE(A.HAS_AIRBAG,B.HAS_AIRBAG) AS HAS_AIRBAG
, COALESCE(A.SITE_CURRENCY_ID,B.SITE_CURRENCY_ID) AS SITE_CURRENCY_ID
, COALESCE(A.SITE_CURRENCY_ITEM_PRICE,B.SITE_CURRENCY_ITEM_PRICE) AS SITE_CURRENCY_ITEM_PRICE
, COALESCE(A.ITEM_LOCAL_PRICE,B.ITEM_LOCAL_PRICE) AS ITEM_LOCAL_PRICE
, COALESCE(A.ITEM_USD_PRICE,B.ITEM_USD_PRICE) AS ITEM_USD_PRICE
, MAX_DATE_IN_THE_MONTH

-- COMIENZO DE METRICAS 
, SUM(ML_CONTACTOS_TOTALES_UNIQUE) AS ML_CONTACTOS_TOTALES_UNIQUE
, SUM(TC_CONTACTOS_TOTALES_UNIQUE) AS TC_CONTACTOS_TOTALES_UNIQUE
, SUM(CONTACTOS_TOTALES_UNIQUE) AS CONTACTOS_TOTALES_UNIQUE
, SUM(ML_CALL) AS ML_CALL
, SUM(TC_CALL) AS TC_CALL
, SUM(CALL) AS CALL
, SUM(ML_WHATSAPP) AS ML_WHATSAPP
, SUM(TC_WHATSAPP) AS TC_WHATSAPP
, SUM(WHATSAPP) AS WHATSAPP
, SUM(ML_PREGUNTAS_UNICOS) AS ML_PREGUNTAS_UNICOS
, SUM(TC_PREGUNTAS_UNICOS) AS TC_PREGUNTAS_UNICOS
, SUM(PREGUNTAS_UNICOS) AS PREGUNTAS_UNICOS
, SUM(ML_ENTREGAS) AS ML_ENTREGAS
, SUM(TC_ENTREGAS) AS TC_ENTREGAS
, SUM(ENTREGAS) AS ENTREGAS
, SUM(VIEW_PHONE) AS VIEW_PHONE
, SUM(VISITAS_IOS) AS VISITAS_IOS
, SUM(VISITAS_ANDROID) AS VISITAS_ANDROID
, SUM(VISITAS_MOBILEWEB) AS VISITAS_MOBILEWEB
, SUM(VISITAS_STD_DESKTOP) AS VISITAS_STD_DESKTOP
, SUM(VISITAS_OTROS) AS VISITAS_OTROS
, SUM(VISITAS_TOTAL) AS VISITAS_TOTAL
, SUM(ITEMS_MENSUAL) AS ITEMS_MENSUAL
, SUM(LIVE_LISTINGS) AS LIVE_LISTINGS

FROM `meli-bi-data.SBOX_MKTVIS.DASH_MOTORS_LIVE_LISTINGS_MONTHLY` AS A

FULL OUTER JOIN `meli-bi-data.SBOX_MKTVIS.DASH_MOTORS_LEADS_VISITS_MONTHLY` AS B
ON A.YEAR_MONTH = B.YEAR_MONTH
AND A.SITE_ID = B.SITE_ID
AND A.ITEM_ID = B.ITEM_ID

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50
;

-- NUEVO: COMENTO POR DUPLICAR
--CONTROL: ITEMS: 9789322 MLB 1743 NOVIEMBRE
--PARA CORRER ESTA QUERY SOLAMENTE ES NECESARIO MODIFICAR LAS SIGUIENTES FECHAS SEGUN LA NECESIDAD
DECLARE FECHA_INICIAL DATE DEFAULT '2022-06-01';
DECLARE FECHA_FINAL DATE DEFAULT '2022-11-30';
--INGRESAR LOS SITES A CONSULTAR
DECLARE VAR_SITES ARRAY <STRING>;
SET VAR_SITES = ['MCO','MLA','MLB','MLC','MLM','MLU','MLV'];

WITH ATRIBUTOS AS
(
  SELECT
      SIT_SITE_ID
    , USER_TYPE
    , CUS_CUST_ID
    , NOMBREDELCUS
    , ITE_ITEM_ID
    , TITULO_PUBLICACION 
    , TIER 
    , ESTADO 
    , CIUDAD 
    , CALLE_UBICACION
    , BARRIO_UBICACION
    , LATITUD
    , LONGITUD 
    , CATEGORIA_L1 
    , CATEGORIA_L2 
    , CATEGORIA_L3
    , COMBO 
    , ITEM_PADRE 
    , ITE_ITEM_DOM_DOMAIN_ID
    , MONEDA_PRECIO 
    , PRECIO 
    , TIPO_LISTING 
    , CONDICION_ITEM 
    , CAST(REGEXP_EXTRACT(LEFT(KILOMETROS,8),'[0-9]+') AS NUMERIC) AS KILOMETROS
    , CAST(LEFT(ANO,4) AS NUMERIC) AS ANO
    , MARCA
    , MODELO 
    , CARROCERIA
    , VERSION_CORTA 
    , VERSION 
    , TRASMISION
    , MOTORS 
    , TIPO_COMBUSTIBLE 
    , PUERTAS
    , COLOR 
    , LLANTAS
    , PATENTE_PLACA 
    , CONTROL_DE_TRACCION
    , TIPO_MOTO 
    , CC 

  -- COMIENZO BOOLEANOS
    , VIDEO AS HAS_VIDEO

    , (CASE WHEN REGEXP_CONTAINS(UPPER(UNICO_DUENO), 'S.*') IS TRUE THEN TRUE
              WHEN REGEXP_CONTAINS(UPPER(UNICO_DUENO), 'N.*') IS TRUE THEN TRUE 
              END) AS IS_SINGLE_OWNER

    , (CASE WHEN REGEXP_CONTAINS(UPPER(ES_FINANCIABLE), 'S.*') IS TRUE THEN TRUE
              WHEN REGEXP_CONTAINS(UPPER(ES_FINANCIABLE), 'N.*') IS TRUE THEN TRUE 
              END) AS IS_FINANCEABLE
      
    , (CASE WHEN REGEXP_CONTAINS(UPPER(TIENE_CONTROL_ESTABILIDAD), 'S.*') IS TRUE THEN TRUE
              WHEN REGEXP_CONTAINS(UPPER(TIENE_CONTROL_ESTABILIDAD), 'N.*') IS TRUE THEN TRUE 
              END) AS HAS_STABILITY_CONTROL

    , (CASE WHEN (   REGEXP_CONTAINS(UPPER(HAS_ABS_BRAKES), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(FRENOS_ABS), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(TIENE_FRENOS_ABS), 'S.*') IS TRUE
                    ) THEN TRUE
              WHEN (   REGEXP_CONTAINS(UPPER(HAS_ABS_BRAKES), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(FRENOS_ABS), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(TIENE_FRENOS_ABS), 'N.*') IS TRUE
                    ) THEN FALSE
              END) AS HAS_ABS_BRAKES

    , (CASE WHEN (   REGEXP_CONTAINS(UPPER(TIENE_AIRBAG_PASAJERO), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(TIENE_ARIBAG_CONDUCTOR), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_LATERALES), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_DE_CORTINA), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_LATERAL_TRASERO), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_LATERALES_DELANTEROS), 'S.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_DE_IMPACTO_LATERAL), 'S.*') IS TRUE
                    ) THEN TRUE
              WHEN (   REGEXP_CONTAINS(UPPER(TIENE_AIRBAG_PASAJERO), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(TIENE_ARIBAG_CONDUCTOR), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_LATERALES), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_DE_CORTINA), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_LATERAL_TRASERO), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_LATERALES_DELANTEROS), 'N.*') IS TRUE
                    OR REGEXP_CONTAINS(UPPER(AIRBAG_DE_IMPACTO_LATERAL), 'N.*') IS TRUE
                    ) THEN FALSE
              END) AS HAS_AIRBAG

  FROM `meli-bi-data.SBOX_CLASSI_PLANNING.LK_ATRIBUTOS_IMM_IMS` AS A
)

, LL_1 AS
(
  SELECT 
      DATE_TRUNC(I.TIM_DAY,MONTH) AS YEAR_MONTH
    , I.TIM_DAY
    , I.SIT_CURRENCY_ID AS SITE_CURRENCY_ID -- COMENTO POR DUPLICAR
    , I.ITE_CURRENT_PRICE AS SITE_CURRENCY_ITEM_PRICE -- COMENTO POR DUPLICAR
    , (CASE WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') <> 'DOL' THEN ITE_CURRENT_PRICE 
            WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') = 'DOL' THEN SAFE_MULTIPLY(ITE_CURRENT_PRICE , TC.CCO_TC_VALUE)
            ELSE NULL END) AS ITEM_LOCAL_PRICE
    , (CASE WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') = 'DOL' THEN ITE_CURRENT_PRICE 
            WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') <> 'DOL' THEN SAFE_DIVIDE(ITE_CURRENT_PRICE , TC.CCO_TC_VALUE)
            ELSE NULL END) AS ITEM_USD_PRICE
    , ATT.*

  FROM `meli-bi-data.WHOWNER.BT_LIVE_LISTINGS_CLASSIFIEDS` AS I

  LEFT JOIN ATRIBUTOS AS ATT
  ON ATT.ITE_ITEM_ID=I.ITE_ITEM_ID
  AND ATT.SIT_SITE_ID=I.SIT_SITE_ID
  AND I.CAT_CATEG_ID_L1 = '1743'

  -- LE AGREGO TASA DE CAMBIO PARA COLUMNAS DE PRECIO_LOCAL PRECIO_USD
  LEFT JOIN `meli-bi-data.WHOWNER.LK_CURRENCY_CONVERTION` AS TC
  ON I.SIT_SITE_ID = TC.SIT_SITE_ID
    AND I.TIM_DAY	= TC.TIM_DAY_TC


  WHERE I.TIM_DAY BETWEEN FECHA_INICIAL AND FECHA_FINAL
  AND I.SIT_SITE_ID IN ('MCO','MLA','MLB','MLC','MLM','MLU','MLV') -- UNNEST(VAR_SITES)
  AND UPPER(I.ITE_ITEM_STATUS) IN  ('A','ACTIVE')
  AND CAT_CATEG_ID_L1 = '1743'
)

-- PARA HACER EL CALCULO EN BASE A LAS COLUMNAS CREADAS EN LL_1
SELECT DISTINCT
    YEAR_MONTH
  , SIT_SITE_ID
  , USER_TYPE
  , CUS_CUST_ID
  , NOMBREDELCUS
  , ITE_ITEM_ID
  , TITULO_PUBLICACION 
  , TIER 
  , ESTADO 
  , CIUDAD 
  , CALLE_UBICACION
  , BARRIO_UBICACION
  , LATITUD
  , LONGITUD 
  , CATEGORIA_L1 
  , CATEGORIA_L2 
  , CATEGORIA_L3
  , COMBO 
  , ITEM_PADRE 
  , ITE_ITEM_DOM_DOMAIN_ID
  , TIPO_LISTING 
  , CONDICION_ITEM 
  , KILOMETROS
  , ANO
  , MARCA
  , MODELO 
  , CARROCERIA
  , VERSION_CORTA 
  , VERSION 
  , TRASMISION
  , MOTORS 
  , TIPO_COMBUSTIBLE 
  , PUERTAS
  , COLOR 
  , LLANTAS
  , PATENTE_PLACA 
  , CONTROL_DE_TRACCION
  , TIPO_MOTO 
  , CC 
  , HAS_VIDEO
  , IS_SINGLE_OWNER
  , IS_FINANCEABLE
  , HAS_STABILITY_CONTROL
  , HAS_ABS_BRAKES
  , HAS_AIRBAG

-- COMIENZO COLUMNAS WINDOW
  , MAX(SITE_CURRENCY_ID)   OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS SITE_CURRENCY_ID -- COMENTO POR DUPLICAR
  , MAX(SITE_CURRENCY_ITEM_PRICE) OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS SITE_CURRENCY_ITEM_PRICE -- COMENTO POR DUPLICAR
  , MAX(ITEM_LOCAL_PRICE)   OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS ITEM_LOCAL_PRICE -- COMENTO POR DUPLICAR
  , MAX(ITEM_USD_PRICE) OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS ITEM_USD_PRICE -- COMENTO POR DUPLICAR

-- , SUM(0) BUYER
-- , SUM(0) LLAMADAS
-- , SUM(0) WHATSAPP
-- , SUM(0) QUESTION_UNIQUE
-- , SUM(0) QUOT_UNIQUE
-- , SUM(0) RESERVAS
-- , SUM(0) OVER() AS CONTACTOS_TOTALES_UNIQ
-- , SUM(0) OVER() AS CONTACTOS_TOTALES
-- , SUM (0) OVER() AS VISITA
-- , SUM(0) OVER() AS SESIONES
-- , SUM(0) OVER() AS USERS

--COMIENZO METRICAS PARA LIVELISTING: 1. CONTEO DE ITEMS X TIM_DAY. 2. CANTIDAD DE DIAS EN EL MES EN CURSO/CERRADO
  , COUNT(ITE_ITEM_ID) OVER 
  (PARTITION BY 
     YEAR_MONTH
    ,SIT_SITE_ID
    ,USER_TYPE
    ,CUS_CUST_ID
    ,NOMBREDELCUS
    ,ITE_ITEM_ID
    ,TITULO_PUBLICACION 
    ,TIER 
    ,ESTADO 
    ,CIUDAD 
    ,CALLE_UBICACION
    ,BARRIO_UBICACION
    ,LATITUD
    ,LONGITUD 
    ,CATEGORIA_L1 
    ,CATEGORIA_L2 
    ,CATEGORIA_L3
    ,COMBO 
    ,ITEM_PADRE 
    ,ITE_ITEM_DOM_DOMAIN_ID
    ,TIPO_LISTING 
    ,CONDICION_ITEM 
    ,KILOMETROS
    ,ANO
    ,MARCA
    ,MODELO 
    ,CARROCERIA
    ,VERSION_CORTA 
    ,VERSION 
    ,TRASMISION
    ,MOTORS 
    ,TIPO_COMBUSTIBLE 
    ,PUERTAS
    ,COLOR 
    ,LLANTAS
    ,PATENTE_PLACA 
    ,CONTROL_DE_TRACCION
    ,TIPO_MOTO 
    ,CC 
    ,HAS_VIDEO
    ,IS_SINGLE_OWNER
    ,IS_FINANCEABLE
    ,HAS_STABILITY_CONTROL
    ,HAS_ABS_BRAKES
    ,HAS_AIRBAG
  ) AS ITEMS_MENSUAL -- PARTITION SEGUN GROUP BY DE LO QUE QUIERAS TRAERT

  , MAX(TIM_DAY) OVER (PARTITION BY SIT_SITE_ID,YEAR_MONTH) AS MAX_DATE_IN_THE_MONTH

  , (COUNT(ITE_ITEM_ID) OVER 
  (PARTITION BY 
    YEAR_MONTH
    ,SIT_SITE_ID
    ,USER_TYPE
    ,CUS_CUST_ID
    ,NOMBREDELCUS
    ,ITE_ITEM_ID
    ,TITULO_PUBLICACION 
    ,TIER 
    ,ESTADO 
    ,CIUDAD 
    ,CALLE_UBICACION
    ,BARRIO_UBICACION
    ,LATITUD
    ,LONGITUD 
    ,CATEGORIA_L1 
    ,CATEGORIA_L2 
    ,CATEGORIA_L3
    ,COMBO 
    ,ITEM_PADRE 
    ,ITE_ITEM_DOM_DOMAIN_ID
    ,MONEDA_PRECIO 
    ,PRECIO 
    ,TIPO_LISTING 
    ,CONDICION_ITEM 
    ,KILOMETROS
    ,ANO
    ,MARCA
    ,MODELO 
    ,CARROCERIA
    ,VERSION_CORTA 
    ,VERSION 
    ,TRASMISION
    ,MOTORS 
    ,TIPO_COMBUSTIBLE 
    ,PUERTAS
    ,COLOR 
    ,LLANTAS
    ,PATENTE_PLACA 
    ,CONTROL_DE_TRACCION
    ,TIPO_MOTO 
    ,CC 
    ,HAS_VIDEO
    ,IS_SINGLE_OWNER
    ,IS_FINANCEABLE
    ,HAS_STABILITY_CONTROL
    ,HAS_ABS_BRAKES
    ,HAS_AIRBAG
  ) -- NUMERADOR: PARTITION SEGUN GROUP BY DE LO QUE QUIERAS TRAERTE EN ESTE SELECT
  / EXTRACT(DAY FROM MAX(TIM_DAY) OVER (PARTITION BY SIT_SITE_ID,YEAR_MONTH))) AS LL -- DENOMINADOR: CANTIDAD DE D√çAS EN EL MES

FROM LL_1

WHERE SIT_SITE_ID IS NOT NULL

QUALIFY ROW_NUMBER () OVER (PARTITION BY SIT_SITE_ID,YEAR_MONTH,ITE_ITEM_ID) = 1 -- EVITAR DUPLICIDAD GENERADA POR SITE_CURRENCY_ID, SITE_CURRENCY_ITEM_PRICE. PK: Una fila por cada MES, SITE, ITEM
;

